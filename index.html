<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVGA Nebula | Premium Player v3.0.0 by Dollar</title>
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Inter:wght@300;400;600&family=Noto+Kufi+Arabic:wght@400;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/howler@2.0.15/dist/howler.core.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.1.4/dist/jszip.min.js"></script>
    <script src="./build/svga.min.js"></script>
    <style>
        :root {
            --primary: #8b5cf6;
            --secondary: #d946ef;
            --accent: #10b981;
            --bg: #030712;
            --card-bg: rgba(17, 24, 39, 0.7);
            --text: #f9fafb;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1);
            --nebula: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', 'Noto Kufi Arabic', sans-serif;
        }

        body {
            background-color: var(--bg);
            background-image:
                linear-gradient(rgba(3, 7, 18, 0.9), rgba(3, 7, 18, 0.9)),
                url('./bg.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            overflow-x: hidden;
            opacity: 0;
            animation: fadeInPage 1.5s ease-out forwards;
        }

        @keyframes fadeInPage {
            to {
                opacity: 1;
            }
        }

        /* VEO3 Aesthetic: Melancholic & Beautiful animations */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0) rotate(0);
            }

            50% {
                transform: translateY(-15px) rotate(1deg);
            }
        }

        .nebula-glow {
            position: fixed;
            width: 800px;
            height: 800px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.12) 0%, transparent 70%);
            z-index: -1;
            filter: blur(100px);
            pointer-events: none;
        }

        .main-layout {
            max-width: 1600px;
            width: 100%;
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 30px;
            position: relative;
        }

        @media (max-width: 1100px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        header {
            text-align: center;
            margin-bottom: 50px;
            width: 100%;
            animation: float 6s ease-in-out infinite;
        }

        .logo-box {
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
            border-radius: 24px;
            overflow: hidden;
            border: 2px solid var(--border);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
        }

        .logo-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        header h1 {
            font-size: 3.5rem;
            font-weight: 800;
            letter-spacing: -2px;
            background: var(--nebula);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .header-meta {
            display: flex;
            justify-content: center;
            gap: 15px;
            font-size: 0.9rem;
            color: #9ca3af;
            margin-top: 10px;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 100px;
            background: var(--glass);
            border: 1px solid var(--border);
        }

        /* GRID SYSTEM FOR PLAYERS - 6 per row */
        .players-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 20px;
            width: 100%;
        }

        @media (max-width: 1800px) {
            .players-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        @media (max-width: 1400px) {
            .players-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 1100px) {
            .players-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .players-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .players-grid {
                grid-template-columns: 1fr;
            }
        }

        .player-card {
            background: var(--card-bg);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-radius: 20px;
            border: 1px solid var(--border);
            padding: 15px;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 320px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px -15px rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.3);
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .file-name {
            font-weight: 600;
            font-size: 0.75rem;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .close-btn {
            background: transparent;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: 0.2s;
        }

        .close-btn:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .canvas-wrapper {
            width: 100%;
            min-height: 250px;
            max-height: 450px;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 1px solid var(--border);
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
            margin-bottom: 10px;
            overflow: hidden;
        }

        .svga-canvas {
            max-width: 100%;
            max-height: 100%;
            width: auto !important;
            height: auto !important;
            object-fit: contain;
            display: block;
        }

        .card-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: auto;
        }

        .mini-btn {
            background: var(--glass);
            border: 1px solid var(--border);
            color: white;
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .mini-btn:hover {
            background: var(--nebula);
            border-color: transparent;
        }

        /* Sidebar & Inputs */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: var(--card-bg);
            backdrop-filter: blur(30px);
            border-radius: 24px;
            border: 1px solid var(--border);
            padding: 25px;
            transition: 0.3s;
        }

        .panel h3 {
            margin-bottom: 15px;
            font-size: 1rem;
            color: #d1d5db;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        .panel h3 svg {
            color: var(--primary);
        }

        .custom-file-upload {
            display: block;
            width: 100%;
            padding: 30px 20px;
            border: 2px dashed var(--border);
            border-radius: 18px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            color: #9ca3af;
            background: rgba(255, 255, 255, 0.01);
        }

        .custom-file-upload:hover {
            background: rgba(139, 92, 246, 0.05);
            border-color: var(--primary);
            color: white;
        }

        input[type="file"] {
            display: none;
        }

        /* Empty State */
        .empty-grid-msg {
            grid-column: 1 / -1;
            text-align: center;
            padding: 100px;
            color: rgba(255, 255, 255, 0.3);
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .empty-grid-msg svg {
            width: 60px;
            height: 60px;
            opacity: 0.5;
        }

        footer {
            margin-top: 80px;
            text-align: center;
            color: #6b7280;
            font-size: 0.9rem;
            width: 100%;
            padding-bottom: 40px;
        }

        /* Progress Bar in Card */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--nebula);
            width: 0%;
            box-shadow: 0 0 10px var(--primary);
        }
    </style>
</head>

<body>

    <div class="nebula-glow" style="top: -10%; left: -10%;"></div>
    <div class="nebula-glow" style="bottom: -10%; right: -10%;"></div>

    <header>
        <div class="logo-box">
            <img src="./logo.png" alt="SVGA Nebula Logo">
        </div>
        <h1>SVGA Nebula</h1>
        <div class="header-meta">
            <span class="badge">Multi-Grid v3.5.0</span>
            <span class="badge" id="playerCounter">0 / 50 Ù…Ù„ÙØ§Øª</span>
            <span class="badge">6 Ã— 9 Grid</span>
            <span class="badge">NovaDevo</span>
        </div>
    </header>

    <div class="main-layout">

        <!-- Players Grid Area -->
        <div id="playersGrid" class="players-grid">
            <div class="empty-grid-msg">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                    </path>
                </svg>
                <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù„Ù„Ø¹Ø±Ø¶</h3>
                <p>Ù‚Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª (SVGA, GIF, WebP, ØµÙˆØ±) Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø£Ùˆ Ø§Ø³Ø­Ø¨Ù‡Ø§ Ù‡Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©</p>
            </div>
        </div>

        <!-- Sidebar Controls -->
        <div class="sidebar">
            <div class="panel">
                <h3>
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                    Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ØªØ¹Ø¯Ø¯
                </h3>
                <label for="fileInput" class="custom-file-upload">
                    Ø§Ø®ØªØ± Ø­ØªÙ‰ 50 Ù…Ù„Ù (SVGA, GIF, WebP, ØµÙˆØ±)
                    <div style="font-size: 0.7rem; margin-top: 5px; opacity: 0.7;">6 Ù…Ù„ÙØ§Øª ÙÙŠ ÙƒÙ„ ØµÙ â€¢ ÙŠØ¯Ø¹Ù…: SVGA, GIF,
                        WebP, PNG, JPG</div>
                </label>
                <!-- NOTE: 'multiple' attribute added for multi-file support -->
                <input type="file" id="fileInput" accept=".svga,.gif,.webp,.png,.jpg,.jpeg" multiple
                    onchange="handleBatchUpload(event)">
            </div>

            <div class="panel">
                <h3>
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4">
                        </path>
                    </svg>
                    ØªØ­ÙƒÙ… Ø¬Ù…Ø§Ø¹ÙŠ
                </h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="mini-btn" style="justify-content: center;" onclick="playAll()">
                        ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒÙ„
                    </button>
                    <button class="mini-btn" style="justify-content: center;" onclick="stopAll()">
                        Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒÙ„
                    </button>
                </div>
                <button class="mini-btn"
                    style="justify-content: center; width: 100%; margin-top: 10px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border-color: rgba(239, 68, 68, 0.2);"
                    onclick="clearAll()">
                    ØªÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø§Ø´Ø§Øª
                </button>
            </div>

            <div class="panel">
                <h3>
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    ØªØ¹Ù„ÙŠÙ…Ø§Øª
                </h3>
                <p style="font-size: 0.8rem; color: #9ca3af; line-height: 1.6;">
                    âœ¨ Ø§Ø®ØªØ± Ø­ØªÙ‰ 50 Ù…Ù„Ù Ù…Ø¹Ø§Ù‹ (Ctrl+Click)<br>
                    ğŸ“ Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ù„ÙØ§Øª Ù…Ø¨Ø§Ø´Ø±Ø©<br>
                    ğŸ¬ ÙŠØ¯Ø¹Ù…: SVGA, GIF, WebP, PNG, JPG<br>
                    ğŸ® ØªØ­ÙƒÙ… ÙØ±Ø¯ÙŠ ÙˆØ¬Ù…Ø§Ø¹ÙŠ Ù…ØªØ§Ø­
                </p>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2026 SVGA Nebula. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø´Ø±ÙƒØ© NovaDevo</p>
        <p style="margin-top: 5px; opacity: 0.6;">ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„Ø¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ (Grid View)</p>
    </footer>

    <script>
        // Global State
        const MAX_PLAYERS = 50;
        let activePlayers = []; // { id, player, parser, url }

        // DOM Elements
        const playersGrid = document.getElementById('playersGrid');

        // Drop Zone Logic
        document.body.ondragover = function (e) { e.preventDefault(); };
        document.body.ondrop = function (e) {
            e.preventDefault();
            const supportedExtensions = ['.svga', '.gif', '.webp', '.png', '.jpg', '.jpeg'];
            const files = Array.from(e.dataTransfer.files).filter(f => {
                const ext = '.' + f.name.split('.').pop().toLowerCase();
                return supportedExtensions.includes(ext);
            });
            if (files.length > 0) {
                processFiles(files);
            }
        };

        function handleBatchUpload(event) {
            const files = Array.from(event.target.files);
            processFiles(files);
        }

        function processFiles(files) {
            // Calculate available slots
            const availableSlots = MAX_PLAYERS - activePlayers.length;

            if (availableSlots === 0) {
                alert(`âš ï¸ Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (${MAX_PLAYERS} Ù…Ù„ÙØ§Øª)!\nÙŠØ±Ø¬Ù‰ Ø­Ø°Ù Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª Ø£ÙˆÙ„Ø§Ù‹.`);
                return;
            }

            // Take only available slots
            const filesToLoad = files.slice(0, availableSlots);

            if (files.length > availableSlots) {
                alert(`â„¹ï¸ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± ${files.length} Ù…Ù„Ù\nØ³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ ${filesToLoad.length} Ù…Ù„Ù ÙÙ‚Ø· (Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©)\n\nØ§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©: ${activePlayers.length}/${MAX_PLAYERS}`);
            }

            // Remove empty state if exists
            if (activePlayers.length === 0 && filesToLoad.length > 0) {
                playersGrid.innerHTML = '';
            }

            filesToLoad.forEach(file => {
                if (activePlayers.length >= MAX_PLAYERS) return;

                const url = URL.createObjectURL(file);
                createPlayerInstance(file.name, url);
            });

            updatePlayerCounter();
        }

        function createPlayerInstance(fileName, url) {
            const id = 'player-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

            // Detect file type
            const ext = '.' + fileName.split('.').pop().toLowerCase();
            const isSVGA = ext === '.svga';
            const isImage = ['.gif', '.webp', '.png', '.jpg', '.jpeg'].includes(ext);

            // Different controls for SVGA vs Images
            const controlsHTML = isSVGA ? `
                <button class="mini-btn" onclick="getPlayer('${id}').startAnimation()">ØªØ´ØºÙŠÙ„</button>
                <button class="mini-btn" onclick="getPlayer('${id}').pauseAnimation()">Ø¥ÙŠÙ‚Ø§Ù </button>
                <button class="mini-btn" onclick="getPlayer('${id}').stopAnimation()">Ø¥Ù†Ù‡Ø§Ø¡</button>
            ` : `
                <button class="mini-btn" style="opacity: 0.5; cursor: not-allowed;" disabled>ØµÙˆØ±Ø© Ø«Ø§Ø¨ØªØ©</button>
            `;

            const progressHTML = isSVGA ? `
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-${id}"></div>
                </div>
            ` : '';

            const cardHTML = `
                <div class="player-card" id="card-${id}">
                    <div class="player-header">
                        <span class="file-name" title="${fileName}">${fileName}</span>
                        <button class="close-btn" onclick="removePlayer('${id}')">âœ•</button>
                    </div>
                    <div class="canvas-wrapper" id="wrapper-${id}">
                    </div>
                    ${progressHTML}
                    <div class="card-controls">
                        ${controlsHTML}
                    </div>
                </div>
            `;

            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = cardHTML.trim();
            const cardElement = tempDiv.firstChild;
            playersGrid.appendChild(cardElement);

            const wrapper = document.getElementById('wrapper-' + id);

            if (isSVGA) {
                // SVGA handling (existing logic)
                const canvas = document.createElement('canvas');
                canvas.id = id;
                canvas.className = 'svga-canvas';
                wrapper.appendChild(canvas);

                const player = new SVGA.Player('#' + id);
                const parser = new SVGA.Parser('#' + id);

                const playerObj = { id, player, parser, url, type: 'svga' };
                activePlayers.push(playerObj);

                parser.load(url, function (videoItem) {
                    const originalWidth = videoItem.videoSize.width;
                    const originalHeight = videoItem.videoSize.height;
                    const aspectRatio = originalWidth / originalHeight;

                    const containerWidth = wrapper.clientWidth;
                    const maxHeight = 450;
                    const minHeight = 250;

                    let canvasWidth, canvasHeight;

                    canvasWidth = containerWidth;
                    canvasHeight = containerWidth / aspectRatio;

                    if (canvasHeight > maxHeight) {
                        canvasHeight = maxHeight;
                        canvasWidth = maxHeight * aspectRatio;
                    } else if (canvasHeight < minHeight) {
                        canvasHeight = minHeight;
                        canvasWidth = minHeight * aspectRatio;
                    }

                    canvas.style.width = canvasWidth + 'px';
                    canvas.style.height = canvasHeight + 'px';
                    wrapper.style.height = canvasHeight + 'px';

                    canvas.width = originalWidth;
                    canvas.height = originalHeight;

                    player.setVideoItem(videoItem);
                    player.startAnimation();
                    player.onPercentage(function (p) {
                        const fill = document.getElementById('progress-' + id);
                        if (fill) fill.style.width = (p * 100) + '%';
                    });
                }, function (err) {
                    console.error('Error loading ' + fileName, err);
                    cardElement.querySelector('.canvas-wrapper').style.border = '1px solid #ef4444';
                    cardElement.querySelector('.canvas-wrapper').innerHTML = '<div style="color: #ef4444; font-size: 0.7rem; text-align: center;">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>';
                });
            } else if (isImage) {
                // Image handling (GIF, WebP, PNG, JPG)
                const img = document.createElement('img');
                img.src = url;
                img.style.maxWidth = '100%';
                img.style.maxHeight = '100%';
                img.style.width = 'auto';
                img.style.height = 'auto';
                img.style.objectFit = 'contain';
                img.style.display = 'block';

                img.onload = function () {
                    const aspectRatio = img.naturalWidth / img.naturalHeight;
                    const containerWidth = wrapper.clientWidth;
                    const maxHeight = 450;
                    const minHeight = 250;

                    let imgWidth, imgHeight;

                    imgWidth = containerWidth;
                    imgHeight = containerWidth / aspectRatio;

                    if (imgHeight > maxHeight) {
                        imgHeight = maxHeight;
                        imgWidth = maxHeight * aspectRatio;
                    } else if (imgHeight < minHeight) {
                        imgHeight = minHeight;
                        imgWidth = minHeight * aspectRatio;
                    }

                    img.style.width = imgWidth + 'px';
                    img.style.height = imgHeight + 'px';
                    wrapper.style.height = imgHeight + 'px';
                };

                img.onerror = function () {
                    console.error('Error loading image: ' + fileName);
                    wrapper.style.border = '1px solid #ef4444';
                    wrapper.innerHTML = '<div style="color: #ef4444; font-size: 0.7rem; text-align: center;">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©</div>';
                };

                wrapper.appendChild(img);

                const playerObj = { id, img, url, type: 'image' };
                activePlayers.push(playerObj);
            }
        }

        function removePlayer(id) {
            const index = activePlayers.findIndex(p => p.id === id);
            if (index > -1) {
                const p = activePlayers[index];

                // Clean up based on type
                if (p.type === 'svga' && p.player) {
                    p.player.stopAnimation();
                    p.player.clear();
                }
                // For images, just revoke the URL
                if (p.url) {
                    URL.revokeObjectURL(p.url);
                }

                activePlayers.splice(index, 1);

                const card = document.getElementById('card-' + id);
                if (card) {
                    card.style.transform = 'scale(0.8) opacity(0)';
                    setTimeout(() => card.remove(), 300);
                }
            }

            updatePlayerCounter();

            if (activePlayers.length === 0) {
                setTimeout(() => {
                    if (activePlayers.length === 0) showEmptyState();
                }, 350);
            }
        }

        function getPlayer(id) {
            const playerObj = activePlayers.find(p => p.id === id);
            return playerObj?.player || null;
        }

        function playAll() {
            activePlayers.forEach(p => {
                if (p.type === 'svga' && p.player) {
                    p.player.startAnimation();
                }
            });
        }

        function stopAll() {
            activePlayers.forEach(p => {
                if (p.type === 'svga' && p.player) {
                    p.player.stopAnimation();
                }
            });
        }

        function clearAll() {
            // Copy array to avoid modification issues while iterating
            [...activePlayers].forEach(p => removePlayer(p.id));
        }

        function updatePlayerCounter() {
            const counter = document.getElementById('playerCounter');
            if (counter) {
                const count = activePlayers.length;
                counter.textContent = `${count} / ${MAX_PLAYERS} Ù…Ù„ÙØ§Øª`;

                // Visual feedback
                if (count === MAX_PLAYERS) {
                    counter.style.background = 'rgba(239, 68, 68, 0.2)';
                    counter.style.borderColor = 'rgba(239, 68, 68, 0.4)';
                    counter.style.color = '#fca5a5';
                } else if (count > 0) {
                    counter.style.background = 'rgba(16, 185, 129, 0.2)';
                    counter.style.borderColor = 'rgba(16, 185, 129, 0.4)';
                    counter.style.color = '#6ee7b7';
                } else {
                    counter.style.background = 'var(--glass)';
                    counter.style.borderColor = 'var(--border)';
                    counter.style.color = '#9ca3af';
                }
            }
        }

        function showEmptyState() {
            playersGrid.innerHTML = `
                <div class="empty-grid-msg">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª Ù„Ù„Ø¹Ø±Ø¶</h3>
                    <p>Ù‚Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„ÙØ§Øª (SVGA, GIF, WebP, ØµÙˆØ±) Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ø£Ùˆ Ø§Ø³Ø­Ø¨Ù‡Ø§ Ù‡Ù†Ø§ Ù…Ø¨Ø§Ø´Ø±Ø©</p>
                </div>
            `;
        }

        // Resize handler to maintain aspect ratio on window resize
        let resizeTimeout;
        window.addEventListener('resize', function () {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function () {
                activePlayers.forEach(playerObj => {
                    const wrapper = document.getElementById('wrapper-' + playerObj.id);
                    
                    if (!wrapper) return;
                    
                    if (playerObj.type === 'svga') {
                        const canvas = document.getElementById(playerObj.id);
                        if (canvas && playerObj.player.videoItem) {
                            const videoItem = playerObj.player.videoItem;
                            const originalWidth = videoItem.videoSize.width;
                            const originalHeight = videoItem.videoSize.height;
                            const aspectRatio = originalWidth / originalHeight;

                            const containerWidth = wrapper.clientWidth;
                            const maxHeight = 450;
                            const minHeight = 250;

                            let canvasWidth, canvasHeight;

                            canvasWidth = containerWidth;
                            canvasHeight = containerWidth / aspectRatio;

                            if (canvasHeight > maxHeight) {
                                canvasHeight = maxHeight;
                                canvasWidth = maxHeight * aspectRatio;
                            } else if (canvasHeight < minHeight) {
                                canvasHeight = minHeight;
                                canvasWidth = minHeight * aspectRatio;
                            }

                            canvas.style.width = canvasWidth + 'px';
                            canvas.style.height = canvasHeight + 'px';
                            wrapper.style.height = canvasHeight + 'px';
                        }
                    } else if (playerObj.type === 'image' && playerObj.img) {
                        const img = playerObj.img;
                        if (img.naturalWidth && img.naturalHeight) {
                            const aspectRatio = img.naturalWidth / img.naturalHeight;
                            const containerWidth = wrapper.clientWidth;
                            const maxHeight = 450;
                            const minHeight = 250;

                            let imgWidth, imgHeight;

                            imgWidth = containerWidth;
                            imgHeight = containerWidth / aspectRatio;

                            if (imgHeight > maxHeight) {
                                imgHeight = maxHeight;
                                imgWidth = maxHeight * aspectRatio;
                            } else if (imgHeight < minHeight) {
                                imgHeight = minHeight;
                                imgWidth = minHeight * aspectRatio;
                            }

                            img.style.width = imgWidth + 'px';
                            img.style.height = imgHeight + 'px';
                            wrapper.style.height = imgHeight + 'px';
                        }
                    }
                });
            }, 250); // Debounce resize events
        });

        // Initialize with empty state
        // (Already present in HTML)

    </script>
</body>

</html>